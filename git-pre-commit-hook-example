#!/bin/bash
# =============================================================================
# Git Pre-Commit Hook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –µ–∫—Å—Ç—Ä–∞–∫—Ü—ñ—ó XEF —Ñ–∞–π–ª—ñ–≤
# =============================================================================
#
# –í–°–¢–ê–ù–û–í–õ–ï–ù–ù–Ø:
#   1. –°–∫–æ–ø—ñ—é–π—Ç–µ —Ü–µ–π —Ñ–∞–π–ª —É .git/hooks/pre-commit
#   2. –ó—Ä–æ–±—ñ—Ç—å –π–æ–≥–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–º: chmod +x .git/hooks/pre-commit
#   3. –ü—Ä–∏ –∫–æ–∂–Ω–æ–º—É commit –±—É–¥—É—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏—Ç—è–≥—É–≤–∞—Ç–∏—Å—å –∑–º—ñ–Ω–∏ –∑ XEF
#
# –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø:
#   - –ó–º—ñ–Ω—ñ—Ç—å EXTRACTOR_PATH —è–∫—â–æ xef_extractor.py —É —ñ–Ω—à—ñ–π –ø–∞–ø—Ü—ñ
#   - –ó–º—ñ–Ω—ñ—Ç—å AUTO_ADD —è–∫—â–æ –ù–ï —Ö–æ—á–µ—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –¥–æ commit
#
# =============================================================================

# –®–ª—è—Ö –¥–æ –µ–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä–∞ (–≤—ñ–¥–Ω–æ—Å–Ω–æ –∫–æ—Ä–µ–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é)
EXTRACTOR_PATH="xef_extractor.py"

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –≤–∏—Ç—è–≥–Ω—É—Ç—ñ —Ñ–∞–π–ª–∏ –¥–æ commit? (true/false)
AUTO_ADD=true

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ XEF —Ñ–∞–π–ª—ñ–≤...${NC}"

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —ñ—Å–Ω—É—î –µ–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä
if [ ! -f "$EXTRACTOR_PATH" ]; then
    echo -e "${RED}‚ùå –ü–æ–º–∏–ª–∫–∞: $EXTRACTOR_PATH –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!${NC}"
    echo -e "${YELLOW}üí° –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å —â–æ xef_extractor.py –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —É –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é${NC}"
    exit 1
fi

# –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–µ–Ω—ñ XEF —Ñ–∞–π–ª–∏ (staged)
XEF_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -i '\.xef$')

if [ -z "$XEF_FILES" ]; then
    echo -e "${GREEN}‚úì –ù–µ–º–∞—î –∑–º—ñ–Ω–µ–Ω–∏—Ö XEF —Ñ–∞–π–ª—ñ–≤${NC}"
    exit 0
fi

echo -e "${YELLOW}üìù –ó–Ω–∞–π–¥–µ–Ω–æ –∑–º—ñ–Ω–µ–Ω—ñ XEF —Ñ–∞–π–ª–∏:${NC}"
echo "$XEF_FILES" | while read -r file; do
    echo "   ‚Üí $file"
done
echo ""

# –û–±—Ä–æ–±–∏—Ç–∏ –∫–æ–∂–µ–Ω XEF —Ñ–∞–π–ª
SUCCESS_COUNT=0
FAIL_COUNT=0

while IFS= read -r xef_file; do
    if [ -f "$xef_file" ]; then
        echo -e "${BLUE}‚öôÔ∏è  –í–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –∫–æ–¥—É –∑: $xef_file${NC}"
        
        # –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –µ–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä
        if python3 "$EXTRACTOR_PATH" "$xef_file"; then
            ((SUCCESS_COUNT++))
            
            # –í–∏–∑–Ω–∞—á–∏—Ç–∏ –ø–∞–ø–∫—É –∑ –≤–∏—Ç—è–≥–Ω—É—Ç–∏–º –∫–æ–¥–æ–º
            EXTRACTED_DIR="${xef_file%.*}_extracted"
            
            if [ -d "$EXTRACTED_DIR" ]; then
                if [ "$AUTO_ADD" = true ]; then
                    echo -e "${GREEN}   ‚úì –î–æ–¥–∞—é –¥–æ commit: $EXTRACTED_DIR${NC}"
                    git add "$EXTRACTED_DIR"
                else
                    echo -e "${YELLOW}   ‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ –¥–æ–¥–∞—Ç–∏: git add $EXTRACTED_DIR${NC}"
                fi
            fi
        else
            echo -e "${RED}   ‚úó –ü–æ–º–∏–ª–∫–∞ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –∑: $xef_file${NC}"
            ((FAIL_COUNT++))
        fi
        echo ""
    fi
done <<< "$XEF_FILES"

# –ü—ñ–¥—Å—É–º–æ–∫
echo -e "${BLUE}=========================================${NC}"
if [ $FAIL_COUNT -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –ï–∫—Å—Ç—Ä–∞–∫—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ!${NC}"
    echo -e "${GREEN}   –û–±—Ä–æ–±–ª–µ–Ω–æ —Ñ–∞–π–ª—ñ–≤: $SUCCESS_COUNT${NC}"
    exit 0
else
    echo -e "${RED}‚ùå –ï–∫—Å—Ç—Ä–∞–∫—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑ –ø–æ–º–∏–ª–∫–∞–º–∏!${NC}"
    echo -e "${GREEN}   –£—Å–ø—ñ—à–Ω–æ: $SUCCESS_COUNT${NC}"
    echo -e "${RED}   –ü–æ–º–∏–ª–æ–∫: $FAIL_COUNT${NC}"
    echo ""
    echo -e "${YELLOW}üí° –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ–º–∏–ª–∫–∏ –≤–∏—â–µ. Commit —Å–∫–∞—Å–æ–≤–∞–Ω–æ.${NC}"
    exit 1
fi

